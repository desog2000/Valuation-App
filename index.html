<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>FCF Valuation App</title>
  
  <!-- Eruda Console for Mobile Debugging -->
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>
    // Initialize Eruda for debugging
    // Toggle it by adding ?eruda=true to URL or remove this in production
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('eruda') === 'true' || localStorage.getItem('eruda-debug') === 'true') {
      eruda.init();
      localStorage.setItem('eruda-debug', 'true');
    }
    // To enable: Open https://your-github-pages-url.github.io/?eruda=true
    // To disable: localStorage.removeItem('eruda-debug') in console
  </script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Prevent iOS zoom on input focus */
    input, select, textarea {
      font-size: 16px !important;
    }
    
    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }
    
    /* Prevent pull-to-refresh on iOS */
    body {
      overscroll-behavior-y: contain;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    function FCFValuationApp() {
      const [ticker, setTicker] = useState('');
      const [loading, setLoading] = useState(false);
      const [stockData, setStockData] = useState(null);
      const [inputs, setInputs] = useState({
        bearGrowth: 0,
        bearYears: 5,
        bearProb: 20,
        baseGrowth: 0,
        baseYears: 7,
        baseProb: 60,
        bullGrowth: 0,
        bullYears: 10,
        bullProb: 20,
        terminalGrowth: 2.5,
        discountRate: 10
      });
      const [results, setResults] = useState(null);
      const [error, setError] = useState(null);

      const API_KEY = 'NZQSq4xkFo9wY579rcvyYIh0IrqBSpcd';

      const fetchStockData = async () => {
        if (!ticker.trim()) {
          setError('Please enter a ticker symbol');
          return;
        }

        setLoading(true);
        setError(null);
        setStockData(null);
        setResults(null);

        try {
          const tickerUpper = ticker.toUpperCase().trim();
          console.log('Fetching data for:', tickerUpper);

          // Fetch quote data
          const quoteUrl = `https://financialmodelingprep.com/api/v3/quote/${tickerUpper}?apikey=${API_KEY}`;
          console.log('Quote URL:', quoteUrl);
          const quoteRes = await fetch(quoteUrl);
          const quoteData = await quoteRes.json();
          console.log('Quote data:', quoteData);

          if (!quoteData || quoteData.length === 0 || quoteData.error) {
            throw new Error('Ticker not found. Please check the symbol and try again.');
          }

          // Fetch cash flow statement
          const cashFlowUrl = `https://financialmodelingprep.com/api/v3/cash-flow-statement/${tickerUpper}?period=annual&limit=6&apikey=${API_KEY}`;
          console.log('Cash Flow URL:', cashFlowUrl);
          const cashFlowRes = await fetch(cashFlowUrl);
          const cashFlowData = await cashFlowRes.json();
          console.log('Cash Flow data:', cashFlowData);

          if (!cashFlowData || cashFlowData.length === 0) {
            throw new Error('Financial data not available for this ticker.');
          }

          // Fetch income statement for revenue
          const incomeUrl = `https://financialmodelingprep.com/api/v3/income-statement/${tickerUpper}?period=annual&limit=1&apikey=${API_KEY}`;
          console.log('Income URL:', incomeUrl);
          const incomeRes = await fetch(incomeUrl);
          const incomeData = await incomeRes.json();
          console.log('Income data:', incomeData);

          // Fetch balance sheet for debt/cash
          const balanceUrl = `https://financialmodelingprep.com/api/v3/balance-sheet-statement/${tickerUpper}?period=annual&limit=1&apikey=${API_KEY}`;
          console.log('Balance URL:', balanceUrl);
          const balanceRes = await fetch(balanceUrl);
          const balanceData = await balanceRes.json();
          console.log('Balance data:', balanceData);

          // Parse data
          const quote = quoteData[0];
          const currentPrice = quote.price;
          const sharesOutstanding = quote.sharesOutstanding / 1000000;

          const ttmFCF = cashFlowData[0].freeCashFlow / 1000000;
          const ttmRevenue = incomeData[0]?.revenue / 1000000 || 0;

          const totalDebt = balanceData[0]?.totalDebt || 0;
          const cash = balanceData[0]?.cashAndCashEquivalents || 0;
          const netDebt = (totalDebt - cash) / 1000000;

          const dividendYield = quote.dividendYield || 0;

          // Calculate historical FCF growth rates
          const fcfValues = cashFlowData.slice(0, 6).map(d => d.freeCashFlow).reverse();
          
          const growth1yr = fcfValues.length >= 2 
            ? ((fcfValues[fcfValues.length - 1] / fcfValues[fcfValues.length - 2]) - 1) * 100 
            : 0;
          
          const growth3yr = fcfValues.length >= 4
            ? (Math.pow(fcfValues[fcfValues.length - 1] / fcfValues[fcfValues.length - 4], 1/3) - 1) * 100
            : 0;
          
          const growth5yr = fcfValues.length >= 6
            ? (Math.pow(fcfValues[fcfValues.length - 1] / fcfValues[fcfValues.length - 6], 1/5) - 1) * 100
            : 0;

          const data = {
            ticker: tickerUpper,
            currentPrice,
            sharesOutstanding,
            ttmFCF,
            ttmRevenue,
            netDebt,
            dividendYield: dividendYield * 100,
            growth1yr,
            growth3yr,
            growth5yr
          };

          console.log('Parsed stock data:', data);
          setStockData(data);

          setInputs(prev => ({
            ...prev,
            bearGrowth: (growth5yr * 0.5).toFixed(1),
            baseGrowth: growth5yr.toFixed(1),
            bullGrowth: (growth5yr * 1.5).toFixed(1)
          }));

        } catch (err) {
          console.error('Error fetching data:', err);
          setError(err.message || 'Failed to fetch stock data. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      const calculateDCF = (fcf, growthRate, years, terminalRate, discountRate, shares) => {
        let projectedFCF = [];
        let currentFCF = fcf;
        for (let i = 1; i <= years; i++) {
          currentFCF = currentFCF * (1 + growthRate / 100);
          projectedFCF.push(currentFCF);
        }
        let pvProjected = 0;
        projectedFCF.forEach((cashFlow, index) => {
          pvProjected += cashFlow / Math.pow(1 + discountRate / 100, index + 1);
        });
        const terminalFCF = projectedFCF[years - 1] * (1 + terminalRate / 100);
        const terminalValue = terminalFCF / ((discountRate / 100) - (terminalRate / 100));
        const pvTerminal = terminalValue / Math.pow(1 + discountRate / 100, years);
        const enterpriseValue = pvProjected + pvTerminal;
        return enterpriseValue / shares;
      };

      const calculateValuation = () => {
        if (!stockData) return;

        const totalProb = parseFloat(inputs.bearProb) + parseFloat(inputs.baseProb) + parseFloat(inputs.bullProb);
        if (Math.abs(totalProb - 100) > 0.1) {
          alert('Probabilities must sum to 100%');
          return;
        }

        const bearFV = calculateDCF(
          stockData.ttmFCF,
          parseFloat(inputs.bearGrowth),
          parseInt(inputs.bearYears),
          parseFloat(inputs.terminalGrowth),
          parseFloat(inputs.discountRate),
          stockData.sharesOutstanding
        );

        const baseFV = calculateDCF(
          stockData.ttmFCF,
          parseFloat(inputs.baseGrowth),
          parseInt(inputs.baseYears),
          parseFloat(inputs.terminalGrowth),
          parseFloat(inputs.discountRate),
          stockData.sharesOutstanding
        );

        const bullFV = calculateDCF(
          stockData.ttmFCF,
          parseFloat(inputs.bullGrowth),
          parseInt(inputs.bullYears),
          parseFloat(inputs.terminalGrowth),
          parseFloat(inputs.discountRate),
          stockData.sharesOutstanding
        );

        const weightedFV = 
          (bearFV * inputs.bearProb / 100) + 
          (baseFV * inputs.baseProb / 100) + 
          (bullFV * inputs.bullProb / 100);

        const weightedYears = 
          (inputs.bearYears * inputs.bearProb / 100) + 
          (inputs.baseYears * inputs.baseProb / 100) + 
          (inputs.bullYears * inputs.bullProb / 100);

        const futureFV = weightedFV * Math.pow(1 + inputs.terminalGrowth / 100, weightedYears);
        const currentPrice = stockData.currentPrice;
        const expectedReturn = (Math.pow(futureFV / currentPrice, 1 / weightedYears) - 1) * 100;
        const upsideToFV = ((weightedFV - currentPrice) / currentPrice) * 100;
        const bearUpside = ((bearFV - currentPrice) / currentPrice) * 100;
        const bullUpside = ((bullFV - currentPrice) / currentPrice) * 100;

        const buyPrice = baseFV * 0.85;
        const sellPrice = bullFV;

        const resultData = {
          weightedFV,
          expectedReturn,
          weightedYears,
          upsideToFV,
          bearUpside,
          bullUpside,
          bearFV,
          baseFV,
          bullFV,
          buyPrice,
          sellPrice
        };

        console.log('Calculation results:', resultData);
        setResults(resultData);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-indigo-600 to-purple-700 p-2">
          <div className="max-w-6xl mx-auto">
            
            {/* Search Bar Header */}
            <div className="bg-white/95 rounded-lg shadow-lg p-3 mb-2">
              <div className="flex gap-2 items-center">
                <input
                  type="text"
                  value={ticker}
                  onChange={(e) => setTicker(e.target.value.toUpperCase())}
                  onKeyPress={(e) => e.key === 'Enter' && fetchStockData()}
                  placeholder="Enter ticker (e.g., AAPL)"
                  className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg text-base font-semibold focus:border-indigo-600 focus:outline-none"
                  disabled={loading}
                />
                <button
                  onClick={fetchStockData}
                  disabled={loading}
                  className="px-6 py-2 bg-indigo-600 text-white rounded-lg text-base font-bold hover:bg-indigo-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                >
                  {loading ? 'Loading...' : 'Search'}
                </button>
              </div>
              {stockData && (
                <div className="mt-2 text-sm text-gray-600 flex items-center justify-between">
                  <span className="font-semibold">{stockData.ticker}</span>
                  <span className="text-lg font-bold text-gray-800">${stockData.currentPrice.toFixed(2)}</span>
                </div>
              )}
            </div>

            {/* Error Message */}
            {error && (
              <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-2">
                {error}
              </div>
            )}

            {/* Scenario Cards */}
            {stockData && (
              <>
                <div className="bg-white rounded-lg shadow-lg p-2 mb-2">
                  <div className="grid grid-cols-3 gap-2 mb-2">
                    
                    {/* Bear */}
                    <div className="bg-red-50 rounded border-2 border-red-300 p-2">
                      <div className="text-xs font-bold text-red-900 mb-2">üêª Bear</div>
                      <input
                        type="number"
                        step="0.1"
                        value={inputs.bearGrowth}
                        onChange={(e) => setInputs({...inputs, bearGrowth: e.target.value})}
                        className="w-full px-2 py-1 text-sm border border-red-300 rounded mb-1 font-semibold"
                      />
                      <div className="text-xs text-red-700 mb-2">5yr: {stockData.growth5yr.toFixed(1)}%</div>
                      <input
                        type="number"
                        value={inputs.bearYears}
                        onChange={(e) => setInputs({...inputs, bearYears: e.target.value})}
                        className="w-full px-2 py-1 text-sm border border-red-300 rounded mb-1 font-semibold"
                      />
                      <div className="text-xs text-red-700 mb-2">3-5yr moat</div>
                      <input
                        type="number"
                        value={inputs.bearProb}
                        onChange={(e) => setInputs({...inputs, bearProb: e.target.value})}
                        className="w-full px-2 py-1 text-sm border border-red-300 rounded font-semibold"
                      />
                      <div className="text-xs text-red-700 mt-1">Prob: {inputs.bearProb}%</div>
                    </div>

                    {/* Base */}
                    <div className="bg-blue-50 rounded border-2 border-blue-300 p-2">
                      <div className="text-xs font-bold text-blue-900 mb-2">üìä Base</div>
                      <input
                        type="number"
                        step="0.1"
                        value={inputs.baseGrowth}
                        onChange={(e) => setInputs({...inputs, baseGrowth: e.target.value})}
                        className="w-full px-2 py-1 text-sm border border-blue-300 rounded mb-1 font-semibold"
                      />
                      <div className="text-xs text-blue-700 mb-2">5yr: {stockData.growth5yr.toFixed(1)}%</div>
                      <input
                        type="number"
                        value={inputs.baseYears}
                        onChange={(e) => setInputs({...inputs, baseYears: e.target.value})}
                        className="w-full px-2 py-1 text-sm border border-blue-300 rounded mb-1 font-semibold"
                      />
                      <div className="text-xs text-blue-700 mb-2">6-8yr moat</div>
                      <input
                        type="number"
                        value={inputs.baseProb}
                        onChange={(e) => setInputs({...inputs, baseProb: e.target.value})}
                        className="w-full px-2 py-1 text-sm border border-blue-300 rounded font-semibold"
                      />
                      <div className="text-xs text-blue-700 mt-1">Prob: {inputs.baseProb}%</div>
                    </div>

                    {/* Bull */}
                    <div className="bg-green-50 rounded border-2 border-green-300 p-2">
                      <div className="text-xs font-bold text-green-900 mb-2">üöÄ Bull</div>
                      <input
                        type="number"
                        step="0.1"
                        value={inputs.bullGrowth}
                        onChange={(e) => setInputs({...inputs, bullGrowth: e.target.value})}
                        className="w-full px-2 py-1 text-sm border border-green-300 rounded mb-1 font-semibold"
                      />
                      <div className="text-xs text-green-700 mb-2">5yr: {stockData.growth5yr.toFixed(1)}%</div>
                      <input
                        type="number"
                        value={inputs.bullYears}
                        onChange={(e) => setInputs({...inputs, bullYears: e.target.value})}
                        className="w-full px-2 py-1 text-sm border border-green-300 rounded mb-1 font-semibold"
                      />
                      <div className="text-xs text-green-700 mb-2">9-12yr moat</div>
                      <input
                        type="number"
                        value={inputs.bullProb}
                        onChange={(e) => setInputs({...inputs, bullProb: e.target.value})}
                        className="w-full px-2 py-1 text-sm border border-green-300 rounded font-semibold"
                      />
                      <div className="text-xs text-green-700 mt-1">Prob: {inputs.bullProb}%</div>
                    </div>
                  </div>

                  <button
                    onClick={calculateValuation}
                    className="w-full py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded font-bold shadow-lg"
                  >
                    Calculate Valuation
                  </button>
                </div>
              </>
            )}

            {/* Results */}
            {results && stockData && (
              <>
                <div className="bg-white rounded-lg shadow-lg p-4 mb-2">
                  <div className="mb-3 pb-3 border-b-2 border-gray-200">
                    <div className="flex justify-between items-center mb-1">
                      <span className="text-sm text-gray-600">Fair Value</span>
                      <span className="text-2xl font-black text-indigo-600">${results.weightedFV.toFixed(2)}</span>
                    </div>
                    <div className="flex justify-between items-center mb-1">
                      <span className="text-sm text-gray-600">Current Price</span>
                      <span className="text-xl font-bold text-gray-800">${stockData.currentPrice.toFixed(2)}</span>
                    </div>
                    <div className="flex justify-between items-center">
                      <span className="text-sm text-gray-600">Upside to Fair Value</span>
                      <span className={`text-xl font-black ${results.upsideToFV >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                        {results.upsideToFV >= 0 ? '+' : ''}{results.upsideToFV.toFixed(1)}%
                      </span>
                    </div>
                  </div>

                  <div className="space-y-2">
                    <div className="bg-indigo-50 rounded p-2">
                      <div className="text-xs text-gray-600 mb-1">Expected Return</div>
                      <div className="text-lg font-bold text-indigo-700">
                        {results.expectedReturn.toFixed(1)}% annually
                      </div>
                      <div className="text-xs text-gray-600 mt-1">
                        over {results.weightedYears.toFixed(1)} years
                      </div>
                    </div>

                    <div className="bg-red-50 rounded p-2">
                      <div className="text-xs text-gray-600 mb-1">Bear Case Downside</div>
                      <div className="text-lg font-bold text-red-700">
                        {results.bearUpside.toFixed(1)}%
                      </div>
                      <div className="text-xs text-gray-600 mt-1">
                        if conservative scenario plays out
                      </div>
                    </div>

                    <div className="bg-green-50 rounded p-2">
                      <div className="text-xs text-gray-600 mb-1">Bull Case Upside</div>
                      <div className="text-lg font-bold text-green-700">
                        {results.bullUpside >= 0 ? '+' : ''}{results.bullUpside.toFixed(1)}%
                      </div>
                      <div className="text-xs text-gray-600 mt-1">
                        if optimistic scenario plays out
                      </div>
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-2 mb-2">
                  <div className="grid grid-cols-2 gap-3">
                    <div className="bg-green-50 border-2 border-green-400 rounded-lg p-3 text-center">
                      <div className="text-sm font-bold text-green-900 mb-1">Buy Below</div>
                      <div className="text-3xl font-black text-green-700">${results.buyPrice.toFixed(0)}</div>
                      <div className="text-xs text-gray-600 mt-1">15% margin of safety</div>
                    </div>
                    <div className="bg-orange-50 border-2 border-orange-400 rounded-lg p-3 text-center">
                      <div className="text-sm font-bold text-orange-900 mb-1">Sell Above</div>
                      <div className="text-3xl font-black text-orange-700">${results.sellPrice.toFixed(0)}</div>
                      <div className="text-xs text-gray-600 mt-1">Bull case priced in</div>
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-lg p-3">
                  <div className="grid grid-cols-3 gap-2">
                    <div className="bg-gray-50 rounded p-2 text-center">
                      <div className="text-xs text-gray-600 mb-1">TTM Revenue</div>
                      <div className="text-base font-bold">${(stockData.ttmRevenue/1000).toFixed(1)}B</div>
                    </div>
                    <div className="bg-gray-50 rounded p-2 text-center">
                      <div className="text-xs text-gray-600 mb-1">TTM FCF</div>
                      <div className="text-base font-bold">${(stockData.ttmFCF/1000).toFixed(1)}B</div>
                    </div>
                    <div className="bg-gray-50 rounded p-2 text-center">
                      <div className="text-xs text-gray-600 mb-1">FCF Margin</div>
                      <div className="text-base font-bold">{((stockData.ttmFCF / stockData.ttmRevenue) * 100).toFixed(1)}%</div>
                    </div>
                    <div className="bg-gray-50 rounded p-2 text-center">
                      <div className="text-xs text-gray-600 mb-1">FCF Yield</div>
                      <div className="text-base font-bold">{((stockData.ttmFCF / (stockData.currentPrice * stockData.sharesOutstanding)) * 100).toFixed(1)}%</div>
                    </div>
                    <div className="bg-gray-50 rounded p-2 text-center">
                      <div className="text-xs text-gray-600 mb-1">Net Debt</div>
                      <div className="text-base font-bold">
                        {stockData.netDebt < 0 
                          ? `($${Math.abs(stockData.netDebt/1000).toFixed(1)}B)` 
                          : `$${(stockData.netDebt/1000).toFixed(1)}B`}
                      </div>
                    </div>
                    <div className="bg-gray-50 rounded p-2 text-center">
                      <div className="text-xs text-gray-600 mb-1">Div Yield</div>
                      <div className="text-base font-bold">
                        {stockData.dividendYield > 0 ? `${stockData.dividendYield.toFixed(1)}%` : '‚Äî'}
                      </div>
                    </div>
                  </div>
                  <div className="mt-2 text-center bg-indigo-50 rounded p-2">
                    <div className="text-xs text-gray-600 mb-1">Market Cap</div>
                    <div className="text-lg font-bold text-indigo-700">${((stockData.currentPrice * stockData.sharesOutstanding) / 1000).toFixed(1)}B</div>
                  </div>
                </div>
              </>
            )}
          </div>
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<FCFValuationApp />);
  </script>
</body>
</html>
